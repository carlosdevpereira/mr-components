on:
    pull_request:

name: Coverage
jobs:
    publish-code-coverage:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: '16'
                  cache: 'npm'
                  registry-url: https://registry.npmjs.org/
            - run: npm ci
            - name: Generate coverage report
              run: npm run test:unit:coverage
            - name: Deploy coverage report
              id: upload
              uses: cloudflare/pages-action@1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}
                  projectName: mr-components-coverage
                  directory: coverage
                  branch: ${{ github.event.pull_request.head.ref }}
            - name: Comment coverage on active PR
              uses: actions/github-script@v6
              env:
                  BASE_BRANCH_NAME: ${{ github.event.pull_request.base.ref }}
                  BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
                  UPLOAD_ID: ${{ steps.upload.outputs.id }}
                  UPLOAD_URL: ${{ steps.upload.outputs.url }}
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      var BASE_BRANCH_NAME = process.env.BASE_BRANCH_NAME;
                      var BRANCH_NAME = process.env.BRANCH_NAME;
                      var UPLOAD_ID = process.env.UPLOAD_ID;
                      var UPLOAD_URL = process.env.UPLOAD_URL;
                      github.rest.issues.createComment({
                          issue_number: context.issue.number,
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          body: `### ðŸ”– Coverage Report 
                        ---
                        - **Base:** 81% | **Pull Request:** 82%
                        - **Coverage Summary:**
                        
                        |    Type     | Percentage |  Count  |
                        | ----------- | ---------- | ------- |
                        | Statements  |   83.39%   | 638/765 |
                        | Branches    |   91.06%   | 316/347 |
                        | Functions   |   69.12%   | 197/285 |
                        | Lines       |   82.09%   | 573/698 |

                        > Coverage data is based on head (\`${BRANCH_NAME}\`) compared to base (\`${BASE_BRANCH_NAME}\`).

                        [View full coverage report ðŸ”—](${UPLOAD_URL})`})
